<!-- @import "style.less" -->

# Identity Propagation and Assertions

## Introduction

With the growing popularity of protocols based on the OAuth 2.0 specification, there is a need for an interoperable standard that specifies how to convey information about the user from an identity provider (IdP) to a resource server (RS) across security domain boundaries.

## Motivation

To allow an IdP to provide authentication attributes to a number of separately-administered RSs through the use of assertions.

## Identity Propagation

In most architectures, the user's security context propagation stops at the IdP's authority boundaries. In an end-to-end identity propagation, the user's security context is extended to the RS, as illustrated in Figure&nbsp;1.

![Model](./images/identity_propagation_model.svg)

<p class="figure">
Fig.&nbsp;1.&emsp;End-to-End Identity Propagation Model
</p>

The user authenticates at the IdP using an authorization code flow. After successful authentication, the RP/Client obtains an access token, which exchanges at the STS for assertion in a JWT format that carries information about the client and user.

## Assertions

Assertions are statements from an IdP to an RS that contain information about a client and user. The RS uses the information in the assertion to identify the client and user and make authorization decisions about their access to resources controlled by the RS.

## Sequence Diagram

The sequence diagram illustrated in Figure&nbsp;2 shows an identity propagation flow for the user authenticated at the IdP requesting access to resources stored on the RS using a client with a public identifier. The "/.well-known" mechanism and WebFinger queries are used as a means of proving ownership of the client identifier. The following are prerequisites for the given scenario:

1. The IdP, client, and RS SHALL support the specification of OAuth 2.0 Mutual-TLS Client Certificate-Bound Access Tokens.

2. The IdP SHALL support the Token Exchange extension of OAuth 2.0.

3. The subject of the public client certificate (OU and CN attributes) is used as a global client identifier, e.g., OU=_fhir-client, CN=sandbox.example.com.

4. The client's public key hash is published on the client domain (usually identical to the IdP host domain) as a public-key/hash attribute of a JSON document, which is discoverable via WebFinger using the global client identifier, e.g., https<nolink>://example.com/.well-known/webfinger?resource=acct:_fhir-client.sandbox.example.com&rel=public-key.

The sequence diagram is self-explanatory; the OIDC authentication flow is omitted for clarity.

<div class="diagram">
    <img src=./images/identity_propagation_flow_webfinger.svg alt="Sequence Diagram">
</div>

<p class="figure">
Fig.&nbsp;2.&emsp;Identity Propagation Flow
</p>

[DANEâ€”(DANCE WG)](https://github.com/umalabs/identity-propagation-and-assertions/blob/main/images/identity_propagation_flow_dane.svg) and [DNS TXT](https://github.com/umalabs/identity-propagation-and-assertions/blob/main/images/identity_propagation_flow_dns_txt.svg) records are other means of proving ownership of the client identifier.

## Usability Considerations

Using OAuth 2.0 and OpenID Connect technologies is an effective option to secure web APIs. From an API ecosystem perspective, the resource server is the API provider, and the client is the API consumer. The identity propagation system is helpful in B2B scenarios.

#### Trust First

The primary benefit of the identity propagation and assertions concept is that it addresses the trust problem between the identity provider, the API provider, and the API consumer.

#### Third-Party Users to API

To identify the third-party clients and users, use composite API tokens generated by the identity propagation system instead of the API keys, user IDs, and passwords.

#### User to Third-Party APIs

To access third-party APIs, use a composite API token generated by the identity propagation and assertions system that identifies the client and the user. Do not use an API key, user ID, and password.

## Conclusion

[Federizer](https://github.com/umalabs/federizer), an API-to-API security framework, stands as a proof of concept of the Identity Propagation and Assertions architecture.

## Acknowledgment

[NIST Special Publication 800-63C](https://pages.nist.gov/800-63-3/sp800-63c.html), Digital Identity Guidelines: Federation and Assertions, has proven to be an abstract framework for the Identity Propagation and Assertions architecture.